{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>{% if object %}Editar Atributo{% else %}Crear Atributo{% endif %} para el Producto: {{ producto.descripcion }}</h2>
    <form method="post">
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_IDtipo1" class="form-label">Grupo (IDTipo1)</label>
            {{ form.IDtipo1 }}
        </div>
        <div class="mb-3">
            <label for="id_IDtipo2" class="form-label" data-selected="{{ form.IDtipo2.value }}">Subgrupo (IDTipo2)</label>
            {{ form.IDtipo2 }}
        </div>
        <h4>Atributos</h4>
        {% for field in form %}
            {% if "atributo" in field.name %}
            <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {{ field }}
            </div>
            {% endif %}
        {% endfor %}
        <div class="mb-3">
            <label for="id_marca" class="form-label">Marca</label>
            {{ form.marca }}
        </div>
        <div class="mb-3">
            <label for="id_unidad" class="form-label">Unidad</label>
            {{ form.unidad }}
        </div>
        <div class="mb-3">
            <label for="id_cod_alpha" class="form-label">Código Alpha</label>
            <input type="text" id="id_cod_alpha" class="form-control" value="{{ form.initial.cod_alpha|default:'' }}" readonly>
        </div>        
        <button type="submit" class="btn btn-success">Guardar</button>
        <a href="{% url 'desconcatenada_list' producto.id %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const idTipo1Field = document.getElementById('id_IDtipo1');
        const idTipo2Field = document.getElementById('id_IDtipo2');
        const idTipo2Label = document.querySelector('label[for="id_IDtipo2"]'); // Selecciona el label de Subgrupo
        const attributeFields = ['id_atributo1', 'id_atributo2', 'id_atributo3', 'id_atributo4', 'id_atributo5'];

        // Función para cargar Subgrupo y Atributos
        const cargarCampos = (idTipo1) => {
            if (idTipo1) {
                // Mostrar Subgrupo y cargar opciones
                idTipo2Field.parentElement.style.display = '';
                fetch(`/productos/idtipo2/${idTipo1}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error en la solicitud de IDTipo2: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        idTipo2Field.innerHTML = '<option value="">---------</option>';
                        data.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option.id;
                            opt.textContent = option.descripcion;
                            idTipo2Field.appendChild(opt);
                        });

                        // Seleccionar el valor actual si existe
                        const selectedValue = idTipo2Field.dataset.selected;
                        if (selectedValue) {
                            idTipo2Field.value = selectedValue;
                        }
                    })
                    .catch(error => console.error(error));

                // Mostrar y cargar atributos asociados al Grupo
                fetch(`/productos/atributos/${idTipo1}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error en la solicitud de atributos: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        attributeFields.forEach((fieldId, index) => {
                            const field = document.getElementById(fieldId);
                            if (field && data[index]) {
                                field.parentElement.style.display = '';
                                field.previousElementSibling.textContent = data[index];
                            } else if (field) {
                                field.parentElement.style.display = 'none';
                            }
                        });
                    })
                    .catch(error => console.error(error));
            } else {
                // Si no se selecciona Grupo, limpiar Subgrupos y ocultar Atributos
                idTipo2Field.parentElement.style.display = 'none';
                idTipo2Label.textContent = 'Subgrupo (IDTipo2)';
                attributeFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.parentElement.style.display = 'none';
                });
            }
        };

        // Manejar el estado inicial
        if (idTipo1Field.value) {
            // Cargar Subgrupo y Atributos en modo de edición
            cargarCampos(idTipo1Field.value);

            // Si hay un valor seleccionado en IDTipo2, guardarlo en un dataset
            if (idTipo2Field.value) {
                idTipo2Field.setAttribute('data-selected', idTipo2Field.value);
            }
        }

        // Escuchar cambios en el campo IDTipo1
        idTipo1Field.addEventListener('change', function () {
            cargarCampos(idTipo1Field.value);
        });

        // Escuchar cambios en el campo IDTipo2
        idTipo2Field.addEventListener('change', function () {
            const idTipo1 = idTipo1Field.value;

            if (idTipo1) {
                // Mostrar y cargar atributos asociados al Grupo
                fetch(`/productos/atributos/${idTipo1}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error en la solicitud de atributos: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        attributeFields.forEach((fieldId, index) => {
                            const field = document.getElementById(fieldId);
                            if (field && data[index]) {
                                field.parentElement.style.display = '';
                                field.previousElementSibling.textContent = data[index];
                            } else if (field) {
                                field.parentElement.style.display = 'none';
                            }
                        });
                    })
                    .catch(error => console.error(error));
            }
        });
    });
</script>


{% endblock %}
